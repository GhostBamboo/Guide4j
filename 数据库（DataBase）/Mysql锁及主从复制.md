## Mysql锁及主从复制

### 数据库锁

概念： 锁是计算机协调多个进程或线程并发访问某一资源的机制。在数据库中，除传统的计算机资源（如CPU、RAM、I/O等）的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂。

分类：

从对数据操作的类型（读|写）分：

- 读锁（共享锁）：针对同一份数据，多个读操作可以同时进行而不会互相影响。
- 写锁（排它锁）：当前写操作没有完成前，它会阻断其他写锁和读锁。

从对数据操作的粒度分：表锁和行锁。

### Mysql锁机制

分为表锁（偏读）、行锁（偏写）、页锁。

### 表锁（偏读）：

- 偏向MyISAM存储引擎，开销小，加锁快；
- 无死锁；
- 锁的粒度大，发生锁冲突的概率最高，并发度最低。

```sql
#查看表的上锁状态
show open tables like 'mylock';

#给表加读锁或写锁
LOCK table mylock read;
LOCK table mylock write;

#给表释放锁
unlock TABLES;

#表锁分析
show status like 'table%;
```

特点: 

1. 对MyISAM表的读操作(加读锁), 不会阻塞其他线程对同一表的读请求,但会阻塞对同一表的写请求。只有当读锁释放后，才会执行对其他进程的写操作。

2. 对MyISAM表的写操作（加写锁），会阻塞其他进程对同一表的读和写操作，只有当写锁释放后，才会执行其他线程的读写操作。

   简而言之，就是读锁会阻塞写，但是不会阻塞读，而写锁则是读写都阻塞。

表锁分析: 

可以通过检查table_locks_waited和table_locks_immediate状态变量来分析系统上的表锁定。

table_locks_waited：产生表级锁定的次数，表示可以立即获取锁的查询次数，每立即获取锁值加1；

table_locks_immediate：出现表级锁定争用而发生等待的次数（不能立即获取锁的次数，每等待一次锁值加1），此值高则说明存在着较严重的表级锁争用情况。

此外，MyISAM的读写锁调度是写优先，这也使MyISAM不适合做写为主表的引擎。因为写锁后，其他线程不能做任何操作，大量的更新会使查询很难得到锁从而造成永远阻塞。

### 行锁（偏写）

- 偏向InnoDB引擎，开销大。加锁慢；
- 会出现死锁；
- 锁定粒度最小，发生锁冲突的概率最低，并发度也最高。

InnoDB与MyISAM最大的不同点就是支持事务和采用了行级锁。

**间隙锁：**

当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁；对于键值在条件范围内但并不存在的记录，叫做“间隙（GAP)”，InnoDB也会对这个“间隙”加锁，这种锁机制就是所谓的间隙锁（GAP LOCK），间隙锁和行锁合称Next-Key Lock。

危害：因为Query执行过程中通过范围查找的话，它会锁定整个范围内所有的索引键值，即使这个键值并不存在，而造成在锁定的时候无法插入锁定键值范围内的任何数据，在某些场景下可能会对性能造成很大的危害。

**如何对某一行数据加锁？**

SELECT * FROM  TABLE_NAME WHERE  ID = 8 **FOR  UPDATE**; (排它锁)

SELECT * FROM table_name WHERE ... LOCK IN SHARE MODE; (共享锁)

使用该语句对某一行加锁后,其余的操作会被阻塞, 直到锁定行的会话提交commit.

**如何分析行锁定?**

```sql
通过查看InnoDB_row_lock状态变量来分析系统上的行锁的争夺情况。

mysql>show status like 'innodb_row_lock';

各个状态的说明:
InnoDB_row_lock_current_waits: 当前正在等待锁的数量;
InnoDB_row_lock_time: 从系统启动到现在锁定的总时间长度.
```

**行锁优化**

- 尽可能让所有数据检索都通过检索来完成, 避免无索引升级为表锁；
- 合理设计索引，尽量缩小锁的范围；
- 尽可能较少检索条件，避免间隙锁；
- 尽量控制事务大小，减少锁定资源量和时间长度；
- 尽可能低级别事务隔离。

### 页锁

表级锁速度快，但冲突多，行级冲突少，但速度慢。所以取了折衷的页级，一次锁定相邻的一组记录。开销和加锁时间界于表锁和行锁之间；会出现死锁；锁定粒度界于表锁和行锁之间，并发度一般。引擎BDB。